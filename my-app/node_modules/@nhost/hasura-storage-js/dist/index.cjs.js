"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const _=require("fetch-ponyfill"),D=require("form-data"),d=require("xstate");let F=globalThis.fetch;const E=async(t,e,{accessToken:r,name:s,fileId:a,bucketId:o,adminSecret:i,onUploadProgress:l,headers:c={}}={})=>{var U;const h={...c};o&&e.append("bucket-id",o),i&&(h["x-hasura-admin-secret"]=i),r&&(h.Authorization=`Bearer ${r}`);const T=`${t}/files`;if(typeof XMLHttpRequest=="undefined")try{e instanceof D&&(F=_().fetch);const u=await F(T,{method:"POST",headers:h,body:e}),n=await u.json();return u.ok?{fileMetadata:n,error:null}:{error:{status:u.status,message:((U=n==null?void 0:n.error)==null?void 0:U.message)||u.statusText,error:u.statusText},fileMetadata:null}}catch(u){return{error:{status:0,message:u.message,error:u.message},fileMetadata:null}}return new Promise(u=>{let n=new XMLHttpRequest;n.responseType="json",n.onload=()=>{var p,f,L,w,S;return n.status<200||n.status>=300?u({fileMetadata:null,error:{error:(f=(p=n.response)==null?void 0:p.error)!=null?f:n.response,message:(S=(w=(L=n.response)==null?void 0:L.error)==null?void 0:w.message)!=null?S:n.response,status:n.status}}):u({fileMetadata:n.response,error:null})},n.onerror=()=>u({fileMetadata:null,error:{error:n.statusText,message:n.statusText,status:n.status}}),l&&n.upload.addEventListener("progress",l,!1),n.open("POST",T,!0),Object.entries(h).forEach(([p,f])=>{n.setRequestHeader(p,f)}),n.send(e)})};function P(t,e){if(!e||Object.keys(e).length===0)return t;const r=new URL(t),s=Object.entries(e).reduce((a,[o,i])=>({...a,[o.charAt(0)]:i}),{});return Object.entries(s).forEach(([a,o])=>{o&&r.searchParams.set(a,o)}),r.toString()}let g;typeof g=="undefined"&&(g=_().fetch);class I{constructor({url:e}){this.headers={},this.url=e}async uploadFormData({formData:e,bucketId:r,headers:s}){const{error:a,fileMetadata:o}=await E(this.url,e,{bucketId:r,headers:{...this.headers,...s},accessToken:this.accessToken,adminSecret:this.adminSecret});return a?{fileMetadata:null,error:a}:o&&!("processedFiles"in o)?{fileMetadata:{processedFiles:[o]},error:null}:{fileMetadata:o,error:null}}async uploadFile({file:e,bucketId:r,id:s,name:a,headers:o}){const i=typeof window=="undefined"?new D:new FormData;i.append("file[]",e),i.append("metadata[]",JSON.stringify({id:s,name:a}));const{error:l,fileMetadata:c}=await E(this.url,i,{accessToken:this.accessToken,adminSecret:this.adminSecret,bucketId:r,fileId:s,name:a,headers:{...this.headers,...o}});return l?{fileMetadata:null,error:l}:c&&"processedFiles"in c?{fileMetadata:c.processedFiles[0],error:null}:{fileMetadata:c,error:null}}async downloadFile(e){try{const{fileId:r,headers:s,...a}=e,o=P(`${this.url}/files/${r}`,a),i=await g(o,{method:"GET",headers:{...this.generateAuthHeaders(),...this.headers,...s}});if(!i.ok)throw new Error(await i.text());return{file:await i.blob(),error:null}}catch(r){return{file:null,error:r}}}async getPresignedUrl(e){try{const{fileId:r,headers:s}=e,a=await g(`${this.url}/files/${r}/presignedurl`,{method:"GET",headers:{...this.generateAuthHeaders(),...this.headers,...s}});if(!a.ok)throw new Error(await a.text());return{presignedUrl:await a.json(),error:null}}catch(r){return{presignedUrl:null,error:r}}}async delete(e){try{const{fileId:r,headers:s}=e,a=await g(`${this.url}/files/${r}`,{method:"DELETE",headers:{...this.generateAuthHeaders(),...this.headers,...s}});if(!a.ok)throw new Error(await a.text());return{error:null}}catch(r){return{error:r}}}setAccessToken(e){return this.accessToken=e,this}setAdminSecret(e){return this.adminSecret=e,this}getHeaders(){return this.headers}setHeaders(e){return e?(this.headers={...this.headers,...e},this):this}unsetHeaders(){const e=this.headers["x-hasura-role"];return this.headers=e?{"x-hasura-role":e}:{},this}generateAuthHeaders(){if(!(!this.adminSecret&&!this.accessToken))return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:{Authorization:`Bearer ${this.accessToken}`}}}class M{constructor({url:e,adminSecret:r}){this.url=e,this.api=new I({url:e}),this.setAdminSecret(r)}async upload(e){return"file"in e?this.api.uploadFile(e):this.api.uploadFormData(e)}getPublicUrl(e){const{fileId:r,...s}=e;return P(`${this.url}/files/${r}`,s)}async getPresignedUrl(e){const{fileId:r,headers:s,...a}=e,{presignedUrl:o,error:i}=await this.api.getPresignedUrl(e);if(i)return{presignedUrl:null,error:i};if(!o)return{presignedUrl:null,error:new Error("Invalid file id")};const l=P(o.url,a);return{presignedUrl:{...o,url:l},error:null}}async download(e){const{file:r,error:s}=await this.api.downloadFile(e);return s?{file:null,error:s}:r?{file:r,error:null}:{file:null,error:new Error("File does not exist")}}async delete(e){const{error:r}=await this.api.delete(e);return r?{error:r}:{error:null}}setAccessToken(e){return this.api.setAccessToken(e),this}setAdminSecret(e){return this.api.setAdminSecret(e),this}getHeaders(){return this.getHeaders()}setHeaders(e){return this.api.setHeaders(e),this}unsetHeaders(){return this.api.unsetHeaders(),this}}let O;typeof O=="undefined"&&(O=D);const A={progress:null,loaded:0,error:null,bucketId:void 0,file:void 0,id:void 0},R=()=>d.createMachine({predictableActionArguments:!0,schema:{context:{},events:{}},tsTypes:{},context:{...A},initial:"idle",on:{DESTROY:{actions:"sendDestroy",target:"stopped"}},states:{idle:{on:{ADD:{actions:"addFile"},UPLOAD:{cond:"hasFile",target:"uploading"}}},uploading:{entry:"resetProgress",on:{UPLOAD_PROGRESS:{actions:["incrementProgress","sendProgress"]},UPLOAD_DONE:"uploaded",UPLOAD_ERROR:"error",CANCEL:"idle"},invoke:{src:"uploadFile"}},uploaded:{entry:["setFileMetadata","sendDone"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},error:{entry:["setError","sendError"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},stopped:{type:"final"}}},{guards:{hasFile:(t,e)=>!!t.file||!!e.file},actions:{incrementProgress:d.assign({loaded:(t,{loaded:e})=>e,progress:(t,{progress:e})=>e}),setFileMetadata:d.assign({id:(t,{id:e})=>e,bucketId:(t,{bucketId:e})=>e,progress:t=>100}),setError:d.assign({error:(t,{error:e})=>e}),sendProgress:()=>{},sendError:()=>{},sendDestroy:()=>{},sendDone:()=>{},resetProgress:d.assign({progress:t=>null,loaded:t=>0}),resetContext:d.assign(t=>A),addFile:d.assign({file:(t,{file:e})=>e,bucketId:(t,{bucketId:e})=>e,id:(t,{id:e})=>e})},services:{uploadFile:(t,e)=>r=>{const s=e.file||t.file,a=new O;a.append("file[]",s);let o=0;return E(e.url,a,{fileId:e.id||t.id,bucketId:e.bucketId||t.bucketId,accessToken:e.accessToken,adminSecret:e.adminSecret,name:e.name||s.name,onUploadProgress:i=>{const l=i.total?Math.round(i.loaded*s.size/i.total):0,c=l-o;o=l,r({type:"UPLOAD_PROGRESS",progress:i.total?Math.round(l*100/i.total):0,loaded:l,additions:c})}}).then(({fileMetadata:i,error:l})=>{if(l&&r({type:"UPLOAD_ERROR",error:l}),i&&!("processedFiles"in i)){const{id:c,bucketId:h}=i;r({type:"UPLOAD_DONE",id:c,bucketId:h})}if(i&&"processedFiles"in i){const{id:c,bucketId:h}=i.processedFiles[0];r({type:"UPLOAD_DONE",id:c,bucketId:h})}}),()=>{}}}}),{pure:y,sendParent:m}=d.actions,x=()=>d.createMachine({id:"files-list",schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,context:{progress:null,files:[],loaded:0,total:0},initial:"idle",on:{UPLOAD:{cond:"hasFileToDownload",actions:"addItem",target:"uploading"},ADD:{actions:"addItem"},REMOVE:{actions:"removeItem"}},states:{idle:{entry:["resetProgress","resetLoaded","resetTotal"],on:{CLEAR:{actions:"clearList",target:"idle"}}},uploading:{entry:["upload","startProgress","resetLoaded","resetTotal"],on:{UPLOAD_PROGRESS:{actions:["incrementProgress"]},UPLOAD_DONE:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],UPLOAD_ERROR:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],CANCEL:{actions:"cancel",target:"idle"}}},uploaded:{entry:"setUploaded",on:{CLEAR:{actions:"clearList",target:"idle"}}},error:{on:{CLEAR:{actions:"clearList",target:"idle"}}}}},{guards:{hasFileToDownload:(t,e)=>t.files.some(r=>r.getSnapshot().matches("idle"))||!!e.files,isAllUploaded:t=>t.files.every(e=>{var r;return(r=e.getSnapshot())==null?void 0:r.matches("uploaded")}),isAllUploadedOrError:t=>t.files.every(e=>{const r=e.getSnapshot();return(r==null?void 0:r.matches("error"))||(r==null?void 0:r.matches("uploaded"))})},actions:{incrementProgress:d.assign((t,e)=>{const r=t.loaded+e.additions,s=Math.round(r*100/t.total);return{...t,loaded:r,progress:s}}),setUploaded:d.assign({progress:t=>100,loaded:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetTotal:d.assign({total:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>!e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetLoaded:d.assign({loaded:t=>0}),startProgress:d.assign({progress:t=>0}),resetProgress:d.assign({progress:t=>null}),addItem:d.assign((t,{files:e,bucketId:r})=>{const s=e?Array.isArray(e)?e:"item"in e?Array.from(e):[e]:[],a=t.total+s.reduce((i,l)=>i+l.size,0),o=Math.round(t.loaded*100/a);return{files:[...t.files,...s.map(i=>d.spawn(R().withConfig({actions:{sendProgress:m((l,{additions:c})=>({type:"UPLOAD_PROGRESS",additions:c})),sendDone:m("UPLOAD_DONE"),sendError:m("UPLOAD_ERROR"),sendDestroy:m("REMOVE")}}).withContext({...A,file:i,bucketId:r}),{sync:!0}))],total:a,loaded:t.loaded,progress:o}}),removeItem:d.assign({files:t=>t.files.filter(e=>{var s,a;const r=(s=e.getSnapshot())==null?void 0:s.matches("stopped");return r&&((a=e.stop)==null||a.call(e)),!r})}),clearList:y(t=>t.files.map(e=>d.send({type:"DESTROY"},{to:e.id}))),upload:y((t,e)=>t.files.map(r=>d.send(e,{to:r.id}))),cancel:y(t=>t.files.map(e=>d.send({type:"CANCEL"},{to:e.id})))}}),k=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t}),e.subscribe(s=>{var a;s.matches("error")?r({error:s.context.error,isError:!0,isUploaded:!1}):s.matches("uploaded")&&r({error:null,isError:!1,isUploaded:!0,id:s.context.id,bucketId:s.context.id,name:(a=s.context.file)==null?void 0:a.name})})}),H=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t,files:t.files}),e.onTransition(s=>{s.matches("error")?r({errors:s.context.files.filter(a=>{var o;return(o=a.getSnapshot())==null?void 0:o.context.error}),isError:!0,files:[]}):s.matches("uploaded")&&r({errors:[],isError:!1,files:s.context.files})})});exports.HasuraStorageApi=I;exports.HasuraStorageClient=M;exports.INITIAL_FILE_CONTEXT=A;exports.appendImageTransformationParameters=P;exports.createFileUploadMachine=R;exports.createMultipleFilesUploadMachine=x;exports.uploadFilePromise=k;exports.uploadMultipleFilesPromise=H;
//# sourceMappingURL=index.cjs.js.map
